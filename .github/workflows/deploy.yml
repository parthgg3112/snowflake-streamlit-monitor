name: Deploy to Production

on:
  push:
    branches:
      - main

# 1. GLOBAL ENVIRONMENT VARIABLES
# The Snowflake CLI automatically looks for variables named like this.
# This bypasses the need for a config.toml file entirely.
env:
  SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE: ACCOUNTADMIN
  SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE: DASHBOARD_WH
  SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE: DASHBOARD_DB
  SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA: APP_SCHEMA

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Stick to 3.10 or 3.9 for stability. 
      # 3.11 sometimes has issues with specific library versions in CI.
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs

      # 2. DIAGNOSTIC: Verify Secrets exist (Does not print them, just checks)
      - name: Check Secrets
        run: |
          if [ -z "$SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT" ]; then echo "❌ Account Secret Missing"; exit 1; fi
          if [ -z "$SNOWFLAKE_CONNECTIONS_DEFAULT_USER" ]; then echo "❌ User Secret Missing"; exit 1; fi
          if [ -z "$SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD" ]; then echo "❌ Password Secret Missing"; exit 1; fi
          echo "✅ Credentials injected into Environment successfully."

      # 3. DEPLOY
      # No need to create files. The tool reads the 'env' variables above.
      - name: Deploy to Snowflake
        run: |
          # Drop old app to prevent conflicts
          snow sql --connection default -q "DROP STREAMLIT IF EXISTS Production_Monitor_App"
          
          # Deploy fresh
          snow streamlit deploy Production_Monitor_App --connection default --replace