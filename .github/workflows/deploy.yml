name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs==2.2.0

      - name: Create Global Config
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOW_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          import textwrap
          from pathlib import Path
          
          config_dir = Path.home() / '.snowflake'
          config_dir.mkdir(parents=True, exist_ok=True)
          
          # USE DEDENT TO REMOVE INDENTATION SPACES
          config_content = textwrap.dedent(f'''
          [connections.default]
          account = \"{os.environ['SNOW_ACCOUNT']}\"
          user = \"{os.environ['SNOW_USER']}\"
          password = \"{os.environ['SNOW_PASS']}\"
          role = \"ACCOUNTADMIN\"
          warehouse = \"DASHBOARD_WH\"
          database = \"DASHBOARD_DB\"
          schema = \"APP_SCHEMA\"
          ''').strip()
          
          config_file = config_dir / 'config.toml'
          with open(config_file, 'w') as f:
              f.write(config_content)
              
          print('âœ… Config created cleanly')
          "

      - name: Fix Permissions
        run: chmod 0600 ~/.snowflake/config.toml

      # Debug Step: Print file content (Password masked) to prove structure is valid
      - name: Verify Config Structure
        run: |
          echo "File Content (Secrets Masked):"
          sed 's/password = .*/password = "***"/' ~/.snowflake/config.toml

      - name: Deploy to Snowflake
        run: |
          snow sql -c default -q "DROP STREAMLIT IF EXISTS Production_Monitor_App"
          snow streamlit deploy Production_Monitor_App -c default --replace