name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs

      # 1. Create config.toml in the CURRENT folder (Safe Python Script)
      - name: Create Local Config
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOW_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          
          # We write to 'config.toml' in the current directory
          config_content = f'''[connections.default]
          account = \"{os.environ['SNOW_ACCOUNT']}\"
          user = \"{os.environ['SNOW_USER']}\"
          password = \"{os.environ['SNOW_PASS']}\"
          role = \"ACCOUNTADMIN\"
          warehouse = \"DASHBOARD_WH\"
          database = \"DASHBOARD_DB\"
          schema = \"APP_SCHEMA\"
          '''
          
          with open('config.toml', 'w') as f:
              f.write(config_content)
          
          print('âœ… config.toml created successfully in current folder')
          "

      # 2. Deploy (Pointing explicitly to the file)
      - name: Deploy to Snowflake
        run: |
          # TELL THE TOOL EXACTLY WHERE THE FILE IS
          export SNOWFLAKE_CONFIG_FILE=$(pwd)/config.toml
          
          echo "Using config file at: $SNOWFLAKE_CONFIG_FILE"
          
          # 1. Drop old app
          snow sql --connection default -q "DROP STREAMLIT IF EXISTS Production_Monitor_App"
          
          # 2. Deploy fresh
          snow streamlit deploy Production_Monitor_App --connection default --replace