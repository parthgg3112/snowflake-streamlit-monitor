name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Tools
        run: pip install pytest pandas duckdb snowflake-snowpark-python snowflake-cli-labs

      - name: Run Tests
        run: python -m pytest tests/test_services.py

      # 1. Manually create the config file (Naming the connection "default")
      # 1. Create Config (Same as before - keep this!)
      - name: Create Snowflake Config
        run: |
          mkdir -p ~/.snowflake
          echo "[connections.default]" > ~/.snowflake/config.toml
          echo "account = \"${{ secrets.SNOWFLAKE_ACCOUNT }}\"" >> ~/.snowflake/config.toml
          echo "user = \"${{ secrets.SNOWFLAKE_USER }}\"" >> ~/.snowflake/config.toml
          echo "password = \"${{ secrets.SNOWFLAKE_PASSWORD }}\"" >> ~/.snowflake/config.toml
          echo "role = \"ACCOUNTADMIN\"" >> ~/.snowflake/config.toml
          echo "warehouse = \"DASHBOARD_WH\"" >> ~/.snowflake/config.toml
          echo "database = \"DASHBOARD_DB\"" >> ~/.snowflake/config.toml
          echo "schema = \"APP_SCHEMA\"" >> ~/.snowflake/config.toml

      # 2. THE FIX: Delete the old app first (SQL), then Deploy new one
      - name: Deploy to Snowflake
        run: |
          # Step A: Destroy the old app (Using the 'default' connection credentials)
          snow sql --connection default -q "DROP STREAMLIT IF EXISTS DASHBOARD_DB.APP_SCHEMA.Production_Monitor_App"
          
          # Step B: Deploy the new app (Using the 'default' connection credentials)
          snow streamlit deploy Production_Monitor_App --connection default