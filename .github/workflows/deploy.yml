name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define environment variables globally for all steps
    env:
      SNOWFLAKE_CONFIG_FILE: ./config.toml  # Force tool to read config from current folder

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.3'

      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs

      # üîç DIAGNOSTIC STEP: Check if secrets actually exist
      - name: Verify Secrets
        run: |
          echo "Checking secrets..."
          if [ -z "${{ secrets.SNOWFLAKE_ACCOUNT }}" ]; then
            echo "::error::‚ùå CRITICAL: SNOWFLAKE_ACCOUNT secret is EMPTY. Go to GitHub Settings > Secrets."
            exit 1
          fi
          if [ -z "${{ secrets.SNOWFLAKE_USER }}" ]; then
            echo "::error::‚ùå CRITICAL: SNOWFLAKE_USER secret is EMPTY."
            exit 1
          fi
          if [ -z "${{ secrets.SNOWFLAKE_PASSWORD }}" ]; then
            echo "::error::‚ùå CRITICAL: SNOWFLAKE_PASSWORD secret is EMPTY."
            exit 1
          fi
          echo "‚úÖ All secrets are present!"

      # üõ†Ô∏è CONFIG STEP: Create config.toml in CURRENT folder (using Python for safety)
      - name: Create Local Config
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOW_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          
          config_content = f'''[connections.default]
          account = \"{os.environ['SNOW_ACCOUNT']}\"
          user = \"{os.environ['SNOW_USER']}\"
          password = \"{os.environ['SNOW_PASS']}\"
          role = \"ACCOUNTADMIN\"
          warehouse = \"DASHBOARD_WH\"
          database = \"DASHBOARD_DB\"
          schema = \"APP_SCHEMA\"
          '''
          
          with open('config.toml', 'w') as f:
              f.write(config_content)
          print('‚úÖ Created config.toml in current directory')
          "

      # üöÄ DEPLOY STEP
      - name: Deploy to Snowflake
        run: |
          # 1. Drop old app to prevent conflicts
          snow sql --connection default -q "DROP STREAMLIT IF EXISTS DASHBOARD_DB.APP_SCHEMA.Production_Monitor_App"
          
          # 2. Deploy fresh
          snow streamlit deploy Production_Monitor_App --connection default