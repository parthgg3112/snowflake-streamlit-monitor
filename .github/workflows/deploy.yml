name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 1. INSTALL STABLE VERSION (Crucial Fix)
      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs==2.2.0

      # 2. Create Config in Default Home Location
      - name: Create Global Config
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOW_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          from pathlib import Path
          
          # Create ~/.snowflake directory
          config_dir = Path.home() / '.snowflake'
          config_dir.mkdir(parents=True, exist_ok=True)
          
          # Content for Version 2.2.0
          config_content = f'''[connections.default]
          account = \"{os.environ['SNOW_ACCOUNT']}\"
          user = \"{os.environ['SNOW_USER']}\"
          password = \"{os.environ['SNOW_PASS']}\"
          role = \"ACCOUNTADMIN\"
          warehouse = \"DASHBOARD_WH\"
          database = \"DASHBOARD_DB\"
          schema = \"APP_SCHEMA\"
          '''
          
          # Write file
          with open(config_dir / 'config.toml', 'w') as f:
              f.write(config_content)
              
          print('âœ… Config created at:', config_dir / 'config.toml')
          "

      # 3. Deploy
      - name: Deploy to Snowflake
        run: |
          # Drop old app to clear state
          snow sql -c default -q "DROP STREAMLIT IF EXISTS Production_Monitor_App"
          
          # Deploy fresh (using -c default explicitly)
          snow streamlit deploy Production_Monitor_App -c default --replace