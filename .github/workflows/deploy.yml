name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Force Python 3.9 (The "Safe Harbor" for Snowflake)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 2. Install Dependencies
      - name: Install Tools
        run: pip install streamlit snowflake-snowpark-python pandas plotly snowflake-cli-labs

      # 3. Create Config using PYTHON (Not Bash) to prevent corruption
      - name: Create Snowflake Config
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOW_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          from pathlib import Path
          
          # Create the folder safely
          config_dir = Path.home() / '.snowflake'
          config_dir.mkdir(parents=True, exist_ok=True)
          
          # Write the content cleanly
          config_content = f'''[connections.default]
          account = \"{os.environ['SNOW_ACCOUNT']}\"
          user = \"{os.environ['SNOW_USER']}\"
          password = \"{os.environ['SNOW_PASS']}\"
          role = \"ACCOUNTADMIN\"
          warehouse = \"DASHBOARD_WH\"
          database = \"DASHBOARD_DB\"
          schema = \"APP_SCHEMA\"
          '''
          
          # Save file
          with open(config_dir / 'config.toml', 'w') as f:
              f.write(config_content)
          
          print('âœ… Config file created successfully at', config_dir / 'config.toml')
          "

      # 4. Deploy (Using the default connection we just made)
      - name: Deploy to Snowflake
        run: |
          # A. Clean up old app to prevent conflicts
          snow sql --connection default -q "DROP STREAMLIT IF EXISTS DASHBOARD_DB.APP_SCHEMA.Production_Monitor_App"
          
          # B. Deploy fresh
          snow streamlit deploy Production_Monitor_App --connection default